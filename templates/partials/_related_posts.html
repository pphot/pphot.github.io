{{ $current_page := .Page }}
{{ $current_tags := .Page.Config.tags }}

{{ if $current_tags }}
    {{ $journal_section := get_section "journal" }}
    {{ $thoughts_section := get_section "thoughts" }}
    {{ $books_section := get_section "books" }}
    {{ $all_posts := concat $journal_section.Children $thoughts_section.Children $books_section.Children }}
    
    {{/* Use related_posts function to find posts with shared tags */}}
    {{ $related := related_posts .Page $all_posts }}
    
    {{/* Get max limit from config (default to 10) */}}
    {{ $max_related := .Site.Config.extra.related_posts_max }}
    {{ if not $max_related }}
        {{ $max_related = 10 }}
    {{ end }}
    
    {{/* Count related posts (excluding current page) */}}
    {{ $related_count := 0 }}
    {{ if $related }}
        {{ range $related }}
            {{ if ne .Permalink $current_page.Permalink }}
                {{ $related_count = add $related_count 1 }}
            {{ end }}
        {{ end }}
    {{ end }}
    
    {{ if gt $related_count 0 }}
    <section class="related-posts">
        <h3>You may also like...</h3>
        
        {{/* Track posts shown globally to avoid duplicates across tag groups */}}
        {{ $shown_posts_global := "" }}
        
        {{/* Show posts grouped by tags - limit per tag, not globally */}}
        {{ range $current_tags }}
            {{ $current_tag := . }}
            
            {{/* Count posts for this tag that haven't been shown */}}
            {{ $posts_with_tag_count := 0 }}
            {{ range $related }}
                {{ if ne .Permalink $current_page.Permalink }}
                    {{ $post_marker := printf ",%s," .Permalink }}
                    {{ $shown_posts_padded := printf ",%s," $shown_posts_global }}
                    {{ $already_shown_globally := contains $shown_posts_padded $post_marker }}
                    {{ if not $already_shown_globally }}
                        {{ range .Config.tags }}
                            {{ if eq . $current_tag }}
                                {{ $posts_with_tag_count = add $posts_with_tag_count 1 }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}
            
            {{ if gt $posts_with_tag_count 0 }}
                <div class="related-group">
                    <h4>More posts about <a href="/tags/{{ $current_tag | urlize }}">#{{ $current_tag }}</a></h4>
                    <ul class="related-list">
                        {{ $shown_in_group := 0 }}
                        {{ range $related }}
                            {{ $post := . }}
                            {{/* Respect per-tag limit (10 posts per tag) */}}
                            {{ if and (ne $post.Permalink $current_page.Permalink) (lt $shown_in_group $max_related) }}
                                {{ $post_marker := printf ",%s," $post.Permalink }}
                                {{ $shown_posts_padded := printf ",%s," $shown_posts_global }}
                                {{ $already_shown_globally := contains $shown_posts_padded $post_marker }}
                                {{ if not $already_shown_globally }}
                                    {{ range $post.Config.tags }}
                                        {{ if eq . $current_tag }}
                                            {{ $shown_in_group = add $shown_in_group 1 }}
                                            {{ if $shown_posts_global }}
                                                {{ $shown_posts_global = printf "%s,%s" $shown_posts_global $post.Permalink }}
                                            {{ else }}
                                                {{ $shown_posts_global = $post.Permalink }}
                                            {{ end }}
                                            <li>
                                                <a href="{{ $post.Permalink }}">
                                                    <span class="date">{{ date $post.Config.date "2 Jan 2006" }}</span>
                                                    <span class="title">{{ $post.Config.title }}</span>
                                                </a>
                                            </li>
                                        {{ end }}
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                    </ul>
                </div>
            {{ end }}
        {{ end }}
    </section>
    {{ end }}
{{ end }}
